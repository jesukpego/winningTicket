{% extends 'base/base.html' %}
{% load i18n %}

{% block title %}{% trans "Jouer" %} - {{ game.name }}{% endblock %}

{% block content %}
<div class="relative min-h-screen pt-24 pb-20 overflow-hidden">
    <div class="absolute top-0 left-1/4 -translate-x-1/2 w-full h-full z-0 pointer-events-none">
        <div class="absolute top-[10%] left-[-10%] w-[600px] h-[600px] bg-yellow-400/5 rounded-full blur-[140px]"></div>
        <div class="absolute bottom-[20%] right-[-20%] w-[500px] h-[500px] bg-blue-600/5 rounded-full blur-[120px]">
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">

        <div class="flex items-center gap-4 mb-10 animate-fade-in">
            <a href="{% url 'games' %}"
                class="w-10 h-10 rounded-full bg-slate-900 border border-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:border-yellow-400/50 transition-all">
                <i class="fas fa-arrow-left text-xs"></i>
            </a>
            <div class="flex items-center gap-2 text-xs font-black uppercase tracking-widest text-slate-500">
                <a href="{% url 'home' %}" class="hover:text-white transition-colors">{% trans "Accueil" %}</a>
                <i class="fas fa-chevron-right text-[8px] opacity-30"></i>
                <a href="{% url 'games' %}" class="hover:text-white transition-colors">{% trans "Jeux" %}</a>
                <i class="fas fa-chevron-right text-[8px] opacity-30"></i>
                <span class="text-yellow-400">{{ game.name }}</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

            <div class="lg:col-span-8 space-y-8">

                <div
                    class="bg-slate-900/40 backdrop-blur-xl border border-slate-800/50 rounded-[40px] p-6 sm:p-8 lg:p-12 relative overflow-hidden group">
                    <!-- Jackpot Badge -->
                    <div class="mb-8 lg:absolute lg:top-0 lg:right-0 lg:p-8">
                        <div
                            class="bg-yellow-400/10 border border-yellow-400/20 px-6 py-2 rounded-2xl inline-block lg:block">
                            <p class="text-[10px] font-black text-yellow-500 uppercase tracking-widest text-center"> JACKPOT</p>
                            <p class="text-2xl sm:text-3xl font-black text-white tracking-tighter text-center"> ${{game.prize_amount|floatformat:0 }}</p>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-8 items-center md:items-start text-center md:text-left">
                        <div
                            class="w-32 h-32 rounded-3xl bg-slate-950 border border-slate-800 flex items-center justify-center shadow-2xl group-hover:scale-105 transition-transform duration-500">
                            {% if game.image %}
                            <img src="{{ game.image.url }}" alt="{{ game.name }}"
                                class="w-full h-full object-cover rounded-3xl">
                            {% else %}
                            <i class="fas fa-ticket-alt text-4xl text-yellow-400/20"></i>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div
                                class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-4">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                {% trans "Tirage en cours" %}
                            </div>
                            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black text-white tracking-tighter mb-4">{{ game.name }}</h1>
                            <p class="text-slate-400 font-medium max-w-xl">{{ game.description|default:"Choisissez vos numéros et tentez de décrocher le pactole." }}</p>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-slate-900/40 backdrop-blur-xl border border-slate-800/50 rounded-[40px] p-6 sm:p-8 lg:p-12">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-10">
                        <h2 class="text-2xl font-black text-white tracking-tight uppercase">{% trans "Sélectionnez vos numéros" %}</h2>
                        <div class="flex flex-wrap items-center gap-4 sm:gap-6">
                            <div class="flex items-center gap-2 text-xs font-black text-slate-500">
                                <span class="w-3 h-3 rounded-full bg-slate-800 border border-slate-700"></span>{% trans "Disponible" %}
                            </div>
                            <div class="flex items-center gap-2 text-xs font-black text-yellow-400">
                                <span class="w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)]"></span>{% trans "Sélectionné" %}
                            </div>
                        </div>
                    </div>

                    <form id="ticket-form" method="post">
                        {% csrf_token %}
                        <div class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-3">
                            {% with ''|center:50 as range %}
                            {% for _ in range %}
                            {% with num=forloop.counter %}
                            <label class="relative group cursor-pointer">
                                <input type="checkbox" name="selected_numbers" value="{{ num }}" class="peer hidden" {% if num in taken_numbers %}disabled{% endif %}>
                                <div class="w-full aspect-square bg-slate-950 border border-slate-800 rounded-xl flex items-center justify-center transition-all duration-300
                                        peer-hover:border-slate-500 peer-checked:bg-yellow-400 peer-checked:border-yellow-400 peer-checked:text-slate-950
                                        peer-disabled:opacity-20 peer-disabled:cursor-not-allowed">
                                    <span
                                        class="text-sm font-black text-slate-400 peer-checked:text-slate-950 transition-colors">{{ num }}</span>
                                </div>
                                {% if num in taken_numbers %}
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="w-8 h-[2px] bg-slate-700 rotate-45"></div>
                                </div>
                                {% endif %}
                            </label>
                            {% endwith %}
                            {% endfor %}
                            {% endwith %}
                        </div>

                        <div
                            class="mt-12 p-6 sm:p-8 bg-slate-950/50 rounded-3xl border border-slate-800/30 flex flex-col md:flex-row justify-between items-center gap-8">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-2xl bg-slate-900 border border-slate-800 flex items-center justify-center text-yellow-400">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div>
                                    <p class="text-2xl font-black text-white tracking-tight"><span id="selected-count">0</span> {% trans "Numéros" %}</p>
                                    <p class="text-[10px] font-black text-slate-600 uppercase tracking-widest">{% trans "Sélection illimitée" %}</p>
                                </div>
                            </div>

                            <div class="flex flex-col items-center md:items-end">
                                <p class="text-3xl font-black text-white tracking-tighter mb-1">
                                    <span class="text-yellow-400">$</span><span id="total-price">0.00</span>
                                </p>
                                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">{% trans "Sous-total" %}</p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-8">
                <div
                    class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-[40px] p-6 sm:p-8 text-slate-950 shadow-2xl shadow-yellow-400/10">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-widest opacity-60 mb-1">{% trans "Votre Solde" %}</p>
                            <p class="text-3xl font-black tracking-tighter">${{ user.wallets.first.balance|default:"0.00" }}</p>
                        </div>
                        <div
                            class="w-12 h-12 rounded-2xl bg-slate-950/10 flex items-center justify-center backdrop-blur-sm border border-slate-950/10">
                            <i class="fas fa-wallet text-xl"></i>
                        </div>
                    </div>
                    <button
                        class="w-full py-4 bg-slate-950 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-slate-900 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle text-yellow-400"></i> {% trans "Recharger" %}
                    </button>
                </div>

                <div
                    class="bg-slate-900/40 backdrop-blur-xl border border-slate-800/50 rounded-[40px] p-6 sm:p-8 space-y-8">
                    <h3 class="text-lg font-black text-white uppercase tracking-tight">{% trans "Détails de l'achat" %}
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500 font-bold">{% trans "Prix par numéro" %}</span>
                            <span class="text-white font-black">${{ game.ticket_price }}</span>
                        </div>
                        <div class="h-px bg-slate-800"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-white font-black uppercase text-xs tracking-widest">{% trans "Total à payer" %}</span>
                            <span class="text-2xl font-black text-yellow-400 tracking-tighter">$<span
                                    id="final-total">0.00</span></span>
                        </div>
                    </div>
                    <button type="button" onclick="confirmPurchase()" id="buy-btn" disabled
                        class="w-full py-5 bg-white text-slate-950 disabled:bg-slate-800 disabled:text-slate-500 rounded-2xl font-black text-xs uppercase tracking-[0.2em] transition-all hover:bg-yellow-400 flex items-center justify-center gap-3">
                        {% trans "CONFIRMER L'ACHAT" %} <i class="fas fa-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="confirm-modal" class="fixed inset-0 z-[100] hidden items-center justify-center px-4">
    <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-md" onclick="closeModal()"></div>
    <div
        class="relative bg-slate-900 border border-slate-800 w-full max-w-md rounded-[40px] overflow-hidden shadow-2xl animate-modal-in">
        <div class="p-10 text-center">
            <div
                class="w-20 h-20 bg-yellow-400/10 rounded-3xl flex items-center justify-center mx-auto mb-8 border border-yellow-400/20">
                <i class="fas fa-question-circle text-3xl text-yellow-400"></i>
            </div>
            <h3 class="text-2xl font-black text-white uppercase tracking-tight mb-4">{% trans "Confirmer ?" %}</h3>
            <p class="text-slate-400 mb-10">{% trans "Achat pour" %} <strong>{{ game.name }}</strong>.</p>
            <div class="bg-slate-950/50 rounded-3xl p-6 border border-slate-800/50 mb-10">
                <p class="text-3xl font-black text-white">$<span id="modal-total">0.00</span></p>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="submitPurchase()"
                    class="w-full py-4 bg-yellow-400 text-slate-900 rounded-2xl font-black text-xs uppercase tracking-[0.2em] hover:bg-yellow-300">{% trans "Valider" %}</button>
                <button onclick="closeModal()"
                    class="w-full py-4 bg-slate-800 text-slate-400 rounded-2xl font-black text-xs uppercase tracking-[0.2em]">{% trans "Annuler" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sécurisation des nombres (cas où la locale utilise une virgule)
    const TICKET_PRICE = parseFloat("{{ game.ticket_price }}".replace(',', '.'));
    const USER_BALANCE = parseFloat("{{ user.wallets.first.balance|default:0 }}".replace(',', '.'));

    const buyBtn = document.getElementById('buy-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const totalPriceSpan = document.getElementById('total-price');
    const finalTotalSpan = document.getElementById('final-total');
    const modalTotalSpan = document.getElementById('modal-total');
    const confirmModal = document.getElementById('confirm-modal');
    const checkBoxes = document.querySelectorAll('input[name="selected_numbers"]');

    function updateCart() {
        const count = document.querySelectorAll('input[name="selected_numbers"]:checked').length;
        const total = (count * TICKET_PRICE).toFixed(2);

        selectedCountSpan.textContent = count;
        totalPriceSpan.textContent = total;
        finalTotalSpan.textContent = total;
        modalTotalSpan.textContent = total;

        const canAfford = parseFloat(total) <= USER_BALANCE;

        // Activation du bouton si au moins 1 choix ET assez d'argent
        buyBtn.disabled = !(count > 0 && canAfford);

        // Feedback visuel si solde insuffisant
        if (count > 0 && !canAfford) {
            buyBtn.innerText = "{% trans 'SOLDE INSUFFISANT' %}";
            buyBtn.classList.add('text-red-500');
        } else {
            buyBtn.innerHTML = `{% trans "CONFIRMER L'ACHAT" %} <i class="fas fa-check-circle"></i>`;
            buyBtn.classList.remove('text-red-500');
        }
    }

    checkBoxes.forEach(cb => cb.addEventListener('change', updateCart));

    function confirmPurchase() {
        const selectedCount = document.querySelectorAll('input[name="selected_numbers"]:checked').length;

        if (selectedCount === 0) {
            // Effet de secousse sur la grille pour dire "Hé, choisis un numéro !"
            const grid = document.querySelector('.grid');
            grid.classList.add('animate-shake'); // Ajoute une petite animation
            setTimeout(() => grid.classList.remove('animate-shake'), 500);
            return; // On arrête tout ici
        }

        confirmModal.classList.replace('hidden', 'flex');
    }

    function closeModal() {
        confirmModal.classList.replace('flex', 'hidden');
    }

    function submitPurchase() {
        document.getElementById('ticket-form').submit();
    }
</script>

<style>
    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .animate-shake {
        animation: shake 0.2s ease-in-out 0s 2;
    }

    @keyframes modal-in {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .animate-modal-in {
        animation: modal-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
</style>
{% endblock %}